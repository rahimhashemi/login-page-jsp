#!/bin/sh
# =========================================
# BFF Backend Fully Enhanced POSIX Pre-Commit Hook
# =========================================

set -e

# -----------------------------
# Color definitions (POSIX safe)
# -----------------------------
RED=$(printf '\033[0;31m')
GREEN=$(printf '\033[0;32m')
YELLOW=$(printf '\033[1;33m')
NC=$(printf '\033[0m')

printf "üîç Running BFF backend pre-commit checks...\n"

# -----------------------------
# 1Ô∏è‚É£ Branch protection
# -----------------------------
BRANCH=$(git symbolic-ref --short HEAD)
PROTECTED_BRANCHES="main master release"
for b in $PROTECTED_BRANCHES; do
  if [ "$BRANCH" = "$b" ]; then
    printf "${RED}‚ùå Direct commits to %s are forbidden${NC}\n" "$BRANCH"
    exit 1
  fi
done

# -----------------------------
# 2Ô∏è‚É£ Debug / TODO detection
# -----------------------------
DEBUG_PATTERN='System\.out\.println|printStackTrace|TODO|log\.debug'
for file in $(git diff --cached --name-only); do
  [ -f "$file" ] || continue
  # skip the pre-commit hook itself
  [ "$file" = ".bff-git-hooks/pre-commit" ] && continue
  case "$file" in
    *.java|*.properties|*.yml) ;;  # only scan relevant files
    *) continue ;;
  esac
  if grep -qE "$DEBUG_PATTERN" "$file"; then
    printf "${RED}‚ùå Debug/TODO code detected in %s${NC}\n" "$file"
    exit 1
  fi
done

# -----------------------------
# 3Ô∏è‚É£ Secrets detection
# -----------------------------
SECRET_PATTERN='(AWS_SECRET|PRIVATE_KEY|PASSWORD=|api_key|secret)'
for file in $(git diff --cached --name-only); do
  [ -f "$file" ] || continue
  case "$file" in
    *.java|*.properties|*.yml) ;;
    *) continue ;;
  esac
  if grep -iqE "$SECRET_PATTERN" "$file"; then
    printf "${RED}‚ùå Possible secret detected in %s${NC}\n" "$file"
    exit 1
  fi
done

# -----------------------------
# 4Ô∏è‚É£ File size check
# -----------------------------
MAX_FILE_SIZE=1048576  # 1MB
for file in $(git diff --cached --name-only); do
  [ -f "$file" ] || continue
  size=$(wc -c <"$file")
  if [ "$size" -gt "$MAX_FILE_SIZE" ]; then
    printf "${RED}‚ùå %s exceeds max file size of 1MB${NC}\n" "$file"
    exit 1
  fi
done

# -----------------------------
# 5Ô∏è‚É£ Backend formatting check (Spotless)
# -----------------------------
if [ -f "./mvnw" ]; then
  printf "üé® Checking backend formatting...\n"
  ./mvnw -q spotless:check || {
    printf "${RED}‚ùå Spotless formatting failed${NC}\n"
    exit 1
  }
fi

# -----------------------------
# 6Ô∏è‚É£ Deprecated usage warning
# -----------------------------
for file in $(git diff --cached --name-only); do
  [ -f "$file" ] || continue
  if grep -q '@Deprecated' "$file"; then
    printf "${YELLOW}‚ö† Warning: Deprecated API usage detected in %s${NC}\n" "$file"
  fi
done

# -----------------------------
# 7Ô∏è‚É£ Property key naming convention
# -----------------------------
PROP_PATTERN='^[a-z0-9]+(\.[a-z0-9]+)*='
for file in $(git diff --cached --name-only | grep -E 'application\.properties|application\.yml'); do
  [ -f "$file" ] || continue
  if grep -E -v "$PROP_PATTERN" "$file" > /dev/null; then
    printf "${RED}‚ùå Property key naming convention violated in %s${NC}\n" "$file"
    printf "Expected lowercase letters, numbers, separated by dots (e.g., server.port)\n"
    exit 1
  fi
done

# -----------------------------
# 8Ô∏è‚É£ File naming convention
# -----------------------------
INVALID_FILES=""
for file in $(git diff --cached --name-only); do
  [ -f "$file" ] || continue
  filename=$(basename "$file")
  extension="${filename##*.}"

  case "$extension" in
    java)
      echo "$filename" | grep -qE '^[A-Z][A-Za-z0-9]*\.java$' || \
        INVALID_FILES="$INVALID_FILES\n$file (Java files must be PascalCase)"
      ;;
    properties|yml)
      echo "$filename" | grep -qE '^[a-z0-9.-]+\.'"$extension"'$' || \
        INVALID_FILES="$INVALID_FILES\n$file (Properties/YML must be lowercase with dots/dashes)"
      ;;
    class|log|tmp)
      INVALID_FILES="$INVALID_FILES\n$file (Forbidden extension)"
      ;;
  esac
done

if [ -n "$INVALID_FILES" ]; then
  printf "${RED}‚ùå File naming convention violated:${NC}\n"
  echo "$INVALID_FILES" | sed '/^$/d'
  exit 1
fi

# -----------------------------
# 9Ô∏è‚É£ Large commit warning
# -----------------------------
MAX_FILES=30
FILE_COUNT=$(git diff --cached --name-only | wc -l)
if [ "$FILE_COUNT" -gt "$MAX_FILES" ]; then
  printf "${YELLOW}‚ö† You are committing %d files. Consider splitting the commit.${NC}\n" "$FILE_COUNT"
fi

printf "${GREEN}‚úÖ Pre-commit checks passed for backend${NC}\n"
